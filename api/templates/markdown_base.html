<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/interactive-components.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
        
    <meta name="description" content="{{ description[:160] if description else 'Documentation' }}">
    <meta property="og:title" content="{{ title }}">
    <meta property="og:description" content="{{ description[:300] if description else 'Documentation' }}">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Mdoc">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ title }}">
    <meta name="twitter:description" content="{{ description[:200] if description else 'Documentation' }}">
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    
    {% if recently_updated %}
    <div class="updated-badge">Recently Updated</div>
    {% endif %}
    
    <a href="/" class="back-to-index">‚Üê Back to Index</a>
    
    <h1>{{ title }}</h1>
    
    <div class="action-buttons">
        <a href="?print=1" class="print-button">Print</a>
        <a href="{{ github_edit_url }}" class="github-edit-btn" target="_blank">Edit</a>
        <a href="https://github.com/{{ github_repo }}/issues/new?title=Issue with {{ doc_name }}&body=Page: {{ request.url }}" class="issue-report-btn" target="_blank">Report Issue</a>
        
        {% if versions and versions|length > 0 %}
        <span class="version-toggle" id="version-toggle">History</span>
        {% endif %}
    </div>
    
    {% if versions and versions|length > 0 %}
    <div class="version-list hidden" id="version-list">
        {% for version in versions %}
        <div class="version-item {% if current_hash and current_hash == version.hash %}current-version{% endif %}">
            <a href="/version/{{ doc_name|urlencode }}/{{ version.hash }}">{{ version.short_hash }} - {{ version.message }}</a>
            <div class="version-date">{{ version.date }} by {{ version.author }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if is_version %}
    <a href="/{{ doc_name|urlencode }}" class="back-to-current">‚Üê Current version</a>
    {% endif %}
    
    <div class="search-container">
        <input type="text" id="content-search" placeholder="Search in content...">
    </div>
    
    <div id="doc-content">
        {{ content|safe }}
    </div>
    
    <footer class="footer">
        {% set parts = [] %}
        {% if view_count > 0 %}{% set _ = parts.append('<span class="view-count">Views: ' + view_count|string + '</span>') %}{% endif %}
        {% if contributors and contributors|length > 1 %}
            {% set contrib_list = [] %}
            {% for contributor in contributors %}
                {% if contributor.username != author %}
                    {% set _ = contrib_list.append('<a href="https://github.com/' + contributor.username + '" target="_blank">' + contributor.username + '</a>') %}
                {% endif %}
            {% endfor %}
            {% if contrib_list %}
                {% set _ = parts.append('Contributors: ' + contrib_list|join(', ')) %}
            {% endif %}
        {% endif %}
        {% if author %}{% set _ = parts.append('Written by <a href="https://github.com/' + author + '" target="_blank">' + author + '</a>') %}{% endif %}
        {{ parts|join(' - ')|safe }}
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <script src="{{ url_for('static', filename='js/math-formatter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/glsl-renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/desmos-renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mermaid-renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/geogebra-renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/p5js-renderer.js') }}"></script>
    <script>
        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                button.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }
        function updateViewCount() {
            const pathParts = window.location.pathname.split('/');
            const docName = pathParts[pathParts.length - 1] || 'index';
            
            if (docName === 'index' || docName.includes('.') || docName.startsWith('api')) {
                return;
            }
            
            fetch(`/api/docs/${encodeURIComponent(docName)}`, {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                const viewElements = document.querySelectorAll('.view-count');
                viewElements.forEach(element => {
                    if (data.view_count && data.view_count > 0) {
                        element.textContent = `Views: ${data.view_count}`;
                    }
                });
            })
            .catch(() => {});
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateViewCount, 500);
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const docName = window.location.pathname.replace('/', '') || 'index';
            
            if (docName !== 'index' && !docName.includes('.') && !docName.startsWith('api/')) {
                setTimeout(() => {
                    fetch(`/api/docs/${encodeURIComponent(docName)}`)
                        .then(response => response.json())
                        .then(data => {
                            const viewCountElements = document.querySelectorAll('.view-count, [data-view-count]');
                            viewCountElements.forEach(element => {
                                if (data.view_count) {
                                    element.textContent = `Views: ${data.view_count}`;
                                }
                            });
                        })
                        .catch(error => {
                            console.log('Could not fetch updated view count:', error);
                        });
                }, 100);
            }
        });
        document.addEventListener("DOMContentLoaded", function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const button = document.querySelector('.theme-toggle');
            
            document.body.setAttribute('data-theme', savedTheme);
            button.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            const versionToggle = document.getElementById('version-toggle');
            const versionList = document.getElementById('version-list');
            
            if (versionToggle && versionList) {
                versionToggle.addEventListener('click', function() {
                    versionList.classList.toggle('hidden');
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/live-view-counter.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/search.js') }}"></script>
</body>
</html>